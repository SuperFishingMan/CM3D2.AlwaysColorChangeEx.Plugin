CM3D2.AlwaysColorChangeEx.Plugin
---

パーツごとに色変更やパラメータ調整を可能とするプラグインです。  
まだまだ不具合が残っている可能性があります。

オリジナル作者である[kf-cm3d2](https://github.com/kf-cm3d2) さんとは別人による改造版です。  
[オリジナル](https://github.com/kf-cm3d2/CM3D2.AlwaysColorChange.Plugin)から改造しすぎたため、拡張版として別プロジェクト化しました。  

---
## ■ 導入
#### ◇前提条件  
UnityInjectorが導入済みであること

#### ◇動作確認環境
  **1.22**

#### ◇インストール  

[Release](https://github.com/trzr/CM3D2.AlwaysColorChangeEx.Plugin/releases)ページから、対応するバージョンのzipファイルをダウンロードし、  
解凍後、UnityInjectorフォルダ以下をプラグインフォルダにコピーしてください。

#### ◇自分でコンパイルする場合  
compile.batをサンプルで用意しました。  
レジストリが正しく設定されていればそのままコンパイルできます。  
もし、レジストリの状態と異なるCM3D2ディレクトリを使いたい場合は、  
cmpile.batファイルの以下の環境変数のパスを設定して、バッチを実行してください。
* CM3D2_DIR=C:\KISS\CM3D2  

## ■ 機能概要
#### ◇対象シーン
 * エディット
 * 夜伽
 * ダンス
 * ADVパート

で動作します。

##### ◇機能説明
* **マスク選択**  => マスクアイテム選択画面  
  maskItemで消去されているアイテムを表示させることができます。
   マスクアイテム選択画面で、各スロットのマスクの有無を指定してください。  
   「適用」ボタンで反映します。
* **ノード表示切替え**  => 表示ノード選択画面  
  ノード（身体の部位）の表示・非表示を切り替えられます。  
  「適用」ボタンで反映します。
* **プリセット保存**  
  現在の衣装・設定値をプリセットとして保存します。  
  プリセット適用で呼び出すことがます。  
  - マスククリアを有効にする  
    プリセット適用時、マスククリアを適用するようにします  
    （個々のマスク状態は未対応）
  - 身体も保存する  
    髪型・顔等も保存します。（プリセットの服／体と同等）
* **プリセット適用**  
  保存したプリセットを選択・適用します。


* **menueエクスポート**  
  現在のスロットの設定値をmenu/mate/pmat/model/texファイルとして出力します。
* **テクスチャ変更**  
  ファイル選択による変更と、スライダによる色変更が可能です。  
  - ファイル選択によるテクスチャ変更  
    変更するテクスチャを指定して、「適」ボタンを押下することで適用できます。  
    CM3D2のarcに同梱されているtexファイルは、  
    ファイル名を指定する事で適用できます(.tex省略可能)  
    それ以外のファイルは、「...」ボタンから参照してください。  
    ※　texファイルはMODフォルダ以下など、CM3D2から読み込めるパスに存在する必要あり。  
    pngはダイアログで選択できればパスは任意  
    *対応形式* :.tex, .png
  - スライダによる色変更  
    freeカラー選択時は変更できません。  
   「保存」ボタンでテクスチャ出力に対応(0.0.5.1～)

## ■ 使用方法
##### ◇メニュー操作
F12キーでメニューが開きます。  
キーを変更したい場合は、
* Config/AlwaysColroChange.ini

のToggleWindowキーで指定してください。  
iniファイルの詳細は[wiki](https://github.com/trzr/CM3D2.AlwaysColorChangeEx.Plugin/wiki/ini%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB)を参照

![GUI](http://i.imgur.com/sMm5lo9.jpg  "GUI")

パーツを選択し、RGBAをスライダーで変更することで色が変更されます。  
A(Alpha)は透過可能なシェーダでのみ変更可能です。


##### ◆ マスクアイテム選択画面
![Imgur](http://i.imgur.com/AAxzyMv.png,"マスクアイテム選択画面")

本画面では、チェックが入っている=マスク対象(アイテム非表示)です。
###### ○各ボタンの説明
  * 同期：現在の表示状態に、チェックボタンを合わせる  
  * すべてON：チェックボタンをすべてオン  
  * すべてOFF：チェックボタンをすべてオフ  
  * 適用：チェックボタンに合わせてマスクを適用  
  * クリア：すべてのマスクをクリアする
  * 戻す　：元のマスク状態に戻す  

###### ○アイテムの表示状態
  * 表示中：マスクされていない表示状態
  * 非表示：下着モードやヌードモード等、モードによって非表示化されている状態
  * マスク：マスクされ、非表示の状態
  * 未読込：アイテムが装着されていないなど、対象スロットが読込まれていない状態

##### ◆ 表示ノード選択画面
![Imgur](http://i.imgur.com/9kF6zs4.png, "表示ノード選択画面")

本画面では、チェックが入っている=表示対象(アイテム表示)です。
###### ○各ボタンの説明
  * 同期：現在の表示状態に、チェックボタンを合わせる  
  　　　　表示アイテムの状態も同期します。
  * すべてON：チェックボタンをすべてオン  
  * すべてOFF：チェックボタンをすべてオフ  
  * 適用：チェックボタンに合わせて表示ノードの状態を変更

###### ○アイテムの表示状態
  * 表示中：ノードが表示されている状態
  * 非表示：ノードが非表示の状態  
※ 本画面ではノードの表示状態はリアルタイムには変化しません。  
　 最新の状態に更新する場合は「同期」ボタンを押下してください。

##### ◆ menuエクスポート画面

![Imgur](http://i.imgur.com/oB55edH.png, "menuエクスポート画面")

 ※ ごちゃごちゃしすぎているので見直す可能性大です。

##### ○ エクスポートの仕様
現在は以下のような仕様となっています。
* 保存先  
  Mod/ACC以下
* ファイル名  
  保存ダイアログが開くので、そこでファイル名変更します。  
  CM3D2上に同名のファイルが登録されている場合、保存できません。

* 各ファイルの出力条件
  * **modelファイル**
    - マテリアルのシェーダに変更があった場合
    - 「マテリアル変更」で指定されていないマテリアルのパラメータが変更された場合  
      - 「マテリアル変更」の指定を追加するオプションで対応？（未対応）
  * **mateファイル**  
  　- シェーダに変更があった場合
    - マテリアルのパラメータ(shininess等)に変更があった場合
    - テクスチャファイルに変更があった場合
    - テクスチャの色変更を行った場合
  * **pmatファイル**
    - マテリアルが透過シェーダを使用している場合で、且つ優先度を変更した場合
  * **texファイル**
    - テクスチャファイルに変更があった場合
      - ただし、変更されたファイルが既にCM3D2に登録済みでない場合
    - テクスチャの色変更を行った場合
  * **menuファイル** (めくれ、ずらしなど)
    - 基本的にリソース参照はすべて出力
    - modelファイル
      上位のmenuに対応するスロットのmodelファイルが更新されている場合
    - mateファイル  
      上記のマテリアルと同様の条件であるが、上位のmenuで指定されたマテリアルと同名の場合は出力しない
* 既知の問題
  - メニュー名やマテリアル名未検証（ファイル出力できない文字のチェック等)
  - めくれ・ずらし等のmodelで元のmodelと別マテリアルを指定している場合、  
    テクスチャ変更画面からCM3D2外のtex or pngファイルに変更していると  
    そのロード済みテクスチャをベースに対応するtexファイルを生成する
* 制限事項
  - freeカラー対応の素材（髪、肌等）は非対応
  - .modには非対応  
  - pmatファイルは、SybarisのGameData以下に配置しないと適用されない
  - 同一modelを複数スロットに指定したmenu の場合、同一モデルとして出力する  
  　　⇒ 左右の耳でシェーダを変えるなどが出来ない  
  　　　  (先に参照したマテリアル情報を利用)

##### 強制カラーチェンジ 画面
スライダー値の直接入力の範囲

| スライダー   |  最小 |    最大 | 説明            
|-------------|------:|--------:|:----------------
|RQ           |     0 | 5000    | レンダーキュー(表示優先度)
|Shininess    | -1000 | 1000    | ツヤ
|OutlineWidth |     0 |    1    | アウトライン
|RimPower     |     0 |  100    |　
|RimShift     |   -10 |   10    |　
|HiRate       |     0 |  100    |　
|HiPow        | 0.001 |  100    |　
|FloatValue1  |     0 |  500    | モザイク強度
|FloatValue2  |  -50  |   50    |　
|FloatValue3  |     0 |    1    | 　

## ■ 権利

* オリジナルの作者である[kf-cm3d2](https://github.com/kf-cm3d2)さんの
意向である以下に従ってください。  
(オリジナルの[プロジェクト](https://github.com/kf-cm3d2/CM3D2.AlwaysColorChange.Plugin)READMEに記載)
~~~
ソースの改変・再配布等は自由にしていただいてかまいません。  
むしろやりたいこと・それを超える機能を実装してくれる人歓迎。  
~~~

## ■ 既知の問題
 * 無限色を扱えるカテゴリアイテムのエクスポートがうまく動作しない
   髪全般、顔
 * プリセット保存機能で、マスク状態の保存未対応
 * 表示ノード選択で「適用」すると、マスク変更の状態が元に戻る
   - マスク変更が一時的なフラグ操作だけのため

#### □ TODO
 プロジェクト内の[Wiki](https://github.com/trzr/CM3D2.AlwaysColorChangeEx.Plugin/wiki/TODO)を参照

## ■ 更新履歴
#### 0.1.0.1
* 機能拡張 (**Enhance**)
  * 強制カラーチェンジ画面
    * スライダーの値を直接入力可能に
    * テクスチャ変更のドロップダウンにイメージを表示
    * テクスチャ変更のドロップダウンに任意のtex追加対応
    * menuエクスポートで、登録済みチェックを無視するトグルを追加
* その他 (**Misc**)
  * READMEから各説明をプロジェクト内Wikiに移行
  * ダンス：stellar my tears、イベント回想を動作対象に追加

#### 0.1.0.0
* **プロジェクトをリネーム**
* 機能拡張 (**Enhance**)
  * menuエクスポートの拡張  
    * 画面作り直し
    * シェーダ変更時のmodel/mate書き換え対応
    * テクスチャ変更時のmate/tex書き換え対応
    * pmatファイル出力対応
  * テクスチャ変更画面
    * \_MainTexの色変更を\_ShadowTexに反映させる機能を追加
    * Min,Max値のスライダを相互連動
    * Min=MaxやMid=0の場合にも無限値とならないよう補正を追加

* 不具合修正(**Fixed**)
  * 「テクスチャ変更」画面
    * 適用後テクスチャ名に.texが付与される問題を修正
    * ドロップダウンからの選択文字列を公式の記述書式に修正  
     (小文字から開始)
    * ファイル名の大文字・小文字を区別しないよう修正
  * 「強制カラーチェンジ」画面
    * セット/プリセットから衣装を変更した場合に、画面が追従しない問題を修正  
    * 対象スロットで*\_del\_.menu が選択されたらメインメニューに戻るように修正

#### ～ 0.0.5.2
 *  [旧プロジェクト](https://github.com/trzr/CM3D2.AlwaysColorChange.Plugin#-%E6%9B%B4%E6%96%B0%E5%B1%A5%E6%AD%B4)のページを参照
