# CM3D2.AlwaysColorChangeEx.Plugin

パーツごとに色変更やパラメータ調整を可能とするプラグインです。  
まだまだ不具合が残っている可能性があります。

オリジナル作者である[kf-cm3d2](https://github.com/kf-cm3d2) さんとは別人による改造版です。  
[オリジナル](https://github.com/kf-cm3d2/CM3D2.AlwaysColorChange.Plugin)から改造しすぎたため、拡張版として別プロジェクト化しました。  

---
## ■ 導入
#### ◇前提条件  
UnityInjectorが導入済みであること

#### ◇動作確認環境
1.20

#### ◇インストール  

[Release](https://github.com/trzr/CM3D2.AlwaysColorChangeEx.Plugin/releases)ページから、対応するバージョンのzipファイルをダウンロードし、  
解凍後、UnityInjectorフォルダ以下をプラグインフォルダにコピーしてください。

#### ◇自分でコンパイルする場合  
compile.batをサンプルで用意しました。  
レジストリが正しく設定されていればそのままコンパイルできます。  
もし、レジストリの状態と異なるCM3D2ディレクトリを使いたい場合は、  
cmpile.batファイルの以下の環境変数のパスを設定して、バッチを実行してください。
* CM3D2_DIR=C:\KISS\CM3D2  

## ■ 機能概要
#### ◇対象シーン
 * エディット
 * 夜伽
 * ダンス
 * ADVパート

で動作します。

##### ◇機能説明
* **マスク選択**  => マスクアイテム選択画面  
  maskItemで消去されているアイテムを表示させることができます。
   マスクアイテム選択画面で、各スロットのマスクの有無を指定してください。  
   「適用」ボタンで反映します。
* **ノード表示切替え**  => 表示ノード選択画面  
  ノード（身体の部位）の表示・非表示を切り替えられます。  
  「適用」ボタンで反映します。
* **プリセット保存**  
  現在の衣装・設定値をプリセットとして保存します。  
  プリセット適用で呼び出すことがます。  
  - マスククリアを有効にする  
    プリセット適用時、マスククリアを適用するようにします  
    （個々のマスク状態は未対応）
  - 身体も保存する  
    髪型・顔等も保存します。（プリセットの服／体と同等）
* **プリセット適用**  
  保存したプリセットを選択・適用します。


* **menueエクスポート**  
  現在のスロットの設定値をmenu/mate/pmat/model/texファイルとして出力します。
* **テクスチャ変更**  
  ファイル選択による変更と、スライダによる色変更が可能です。  
  - ファイル選択によるテクスチャ変更  
    変更するテクスチャを指定して、「適」ボタンを押下することで適用できます。  
    CM3D2のarcに同梱されているtexファイルは、  
    ファイル名を指定する事で適用できます(.tex省略可能)  
    それ以外のファイルは、「...」ボタンから参照してください。  
    ※　texファイルはMODフォルダ以下など、CM3D2から読み込めるパスに存在する必要あり。  
    pngはダイアログで選択できればパスは任意  
    *対応形式* :.tex, .png
  - スライダによる色変更  
    freeカラー選択時は変更できません。  
   「保存」ボタンでテクスチャ出力に対応しました。(0.0.5.1～)

## ■ 使用方法
##### ◇メニュー操作
F12キーでメニューが開きます。  
キーを変更したい場合は、
* Config/AlwaysColroChange.ini

のToggleWindowキーで指定してください。  
iniファイルの項目を参照

![GUI](http://i.imgur.com/sMm5lo9.jpg  "GUI")

パーツを選択し、RGBAをスライダーで変更することで色が変更されます。  
A(Alpha)は透過可能なシェーダでのみ変更可能です。


##### ◆ マスクアイテム選択画面
![Imgur](http://i.imgur.com/AAxzyMv.png,"マスクアイテム選択画面")

本画面では、チェックが入っている=マスク対象(アイテム非表示)です。
###### ○各ボタンの説明
  * 同期：現在の表示状態に、チェックボタンを合わせる  
  * すべてON：チェックボタンをすべてオン  
  * すべてOFF：チェックボタンをすべてオフ  
  * 適用：チェックボタンに合わせてマスクを適用  
  * クリア：すべてのマスクをクリアする
  * 戻す　：元のマスク状態に戻す  

###### ○アイテムの表示状態
  * 表示中：マスクされていない表示状態
  * 非表示：下着モードやヌードモード等、モードによって非表示化されている状態
  * マスク：マスクされ、非表示の状態
  * 未読込：アイテムが装着されていないなど、対象スロットが読込まれていない状態

##### ◆ 表示ノード選択画面
![Imgur](http://i.imgur.com/9kF6zs4.png, "表示ノード選択画面")

本画面では、チェックが入っている=表示対象(アイテム表示)です。
###### ○各ボタンの説明
  * 同期：現在の表示状態に、チェックボタンを合わせる  
  　　　　表示アイテムの状態も同期します。
  * すべてON：チェックボタンをすべてオン  
  * すべてOFF：チェックボタンをすべてオフ  
  * 適用：チェックボタンに合わせて表示ノードの状態を変更

###### ○アイテムの表示状態
  * 表示中：ノードが表示されている状態
  * 非表示：ノードが非表示の状態  
※ 本画面ではノードの表示状態はリアルタイムには変化しません。  
　 最新の状態に更新する場合は「同期」ボタンを押下してください。

##### ◆ menuエクスポート画面

![Imgur](http://i.imgur.com/oB55edH.png, "menuエクスポート画面")

 ※ ごちゃごちゃしすぎているので見直す可能性大です。

##### ○ エクスポートの仕様
現在は以下のような仕様となっています。
* 保存先  
  Mod/ACC以下
* ファイル名  
  保存ダイアログが開くので、そこでファイル名変更します。  
  CM3D2上に同名のファイルが登録されている場合、保存できません。  
* 各ファイルの出力条件
  * **modelファイル**
    - マテリアルのシェーダに変更があった場合
    - 「マテリアル変更」で指定されていないマテリアルのパラメータが変更された場合  
      - 「マテリアル変更」の指定を追加するオプションで対応？（未対応）
  * **mateファイル**  
  　- シェーダに変更があった場合
    - マテリアルのパラメータ(shininess等)に変更があった場合
    - テクスチャファイルに変更があった場合
    - テクスチャの色変更を行った場合
  * **pmatファイル**
    - マテリアルが透過シェーダを使用している場合で、且つ優先度を変更した場合
  * **texファイル**
    - テクスチャファイルに変更があった場合
      - ただし、変更されたファイルが既にCM3D2に登録済みでない場合
    - テクスチャの色変更を行った場合
  * **menuファイル** (めくれ、ずらしなど)
    - 基本的にリソース参照はすべて出力
    - modelファイル
      上位のmenuに対応するスロットのmodelファイルが更新されている場合
    - mateファイル  
      上記のマテリアルと同様の条件であるが、上位のmenuで指定されたマテリアルと同名の場合は出力しない

* 既知の問題
  - メニュー名やマテリアル名未検証（ファイル出力できない文字のチェック等)
  - めくれ・ずらし等のmodelで元のmodelと別マテリアルを指定している場合、  
    テクスチャ変更画面からCM3D2外のtex or pngファイルに変更していると  
    そのロード済みテクスチャをベースに対応するtexファイルを生成する

* 制限事項
  - freeカラー対応の素材（髪、肌等）は非対応
  - .modには非対応  
  - 同一modelを複数スロットに指定したmenu の場合、同一モデルとして出力する  
  　　⇒ 左右の耳でシェーダを変えるなどが出来ない  
  　　　  (先に参照したマテリアル情報を利用)

  他にも不具合あるかもしれません。

##### ◇Config/AlwaysColorChangeEx.ini
iniファイルの項目を以下に示す。  
ただし、すべて[Config]セクションとする。

| キー                 |型      |デフォルト | 説明            
|----------------------|-------|:---------:|:----------------
|ToggleWindow          |KeyCode| F12       | メニュー表示キー
|PresetPath            |string | --        | プリセット保存先パス
|SliderShininessMax    | float |  20       | Shininessスライダの最大値
|SliderShininessMin    | float |   0       | Shininessスライダの最小値
|SliderOutlineWidthMax | float |   0.1     | OutlineWidthスライダの最大値
|SliderOutlineWidthMin | float |   0       | OutlineWidthスライダの最小値
|SliderRimPowerMax     | float | 100       | RimPowerスライダの最大値
|SliderRimPowerMin     | float |   0       | RimPowerスライダの最小値
|SliderRimShiftMax     | float |   5       | RimShiftスライダの最大値
|SliderRimShiftMin     | float |  -5       | RimShiftスライダの最小値
|SliderHiRateMax       | float |   1       | HiRateスライダの最大値
|SliderHiRateMin       | float |   0       | HiRateスライダの最小値
|SliderHiPowMax        | float |  50       | HiPowスライダの最大値
|SliderHiPowMin        | float |   0.001   | HiPowスライダの最小値
|SliderFloatVal1Max    | float | 300       | FloatValue1スライダの最大値
|SliderFloatVal1Min    | float |   0       | FloatValue1スライダの最小値
|SliderFloatVal2Max    | float |  15       | FloatValue2スライダの最大値
|SliderFloatVal2Min    | float | -15       | FloatValue2スライダの最小値
|SliderFloatVal3Max    | float |   1       | FloatValue3スライダの最大値
|SliderFloatVal3Min    | float |   0       | FloatValue3スライダの最小値


## ■ 権利

* オリジナルの作者である[kf-cm3d2](https://github.com/kf-cm3d2)さんの意向である以下に従ってください(オリジナルのプロジェクトREADMEに記載)。
~~~
ソースの改変・再配布等は自由にしていただいてかまいません。  
むしろやりたいこと・それを超える機能を実装してくれる人歓迎。  
~~~

## ■ 既知の問題
 * プリセット保存機能で、マスク状態の保存未対応
 * 表示ノード選択で「適用」すると、マスク変更の状態が元に戻る
   - マスク変更が一時的なフラグ操作だけのため

#### □ TODO （やるかも）
 * menuエクスポート機能の拡張  
  * マスク選択、表示/非表示ノードの指定
 * マスク選択
 　 一時適用と適用に分けて、元に戻るのを防止
 * 表示ノード画面
  ノードの構造を見やすく表示。グループごとに選択可能とする等
 * UNDO機能追加
 * 画面サイズに合わせたUI未調整
 * 複数メイド/男への対応
 * 保存プリセットの管理
  名前を指定して削除等

## ■ 更新履歴
#### 0.1.0.0
* **プロジェクトをリネーム**
* 機能拡張 (**Enhance**)
  * menuエクスポートの拡張  
    * 画面作り直し
    * シェーダ変更時のmodel/mate書き換え対応
    * テクスチャ変更時のmate/tex書き換え対応
    * pmatファイル出力対応
  * テクスチャ変更画面
    * \_MainTexの色変更を\_ShadowTexに反映させる機能を追加
    * Min,Max値のスライダを相互連動
    * Min=MaxやMid=0の場合にも無限値とならないよう補正を追加

* 不具合修正(**Fixed**)
  * 「テクスチャ変更」画面
    * 適用後テクスチャ名に.texが付与される問題を修正
    * ドロップダウンからの選択文字列を公式の記述書式に修正  
     (小文字から開始)
    * ファイル名の大文字・小文字を区別しないよう修正
  * 「強制カラーチェンジ」画面
    * セット/プリセットから衣装を変更した場合に、画面が追従しない問題を修正  
    * 対象スロットで*\_del\_.menu が選択されたらメインメニューに戻るように修正

#### 0.0.5.2
* 不具合修正(**Fixed**)
 * ダンスシーン(scarlet leap)の判定ミスを修正
 * menu/mate保存画面でmenuファイルやmodelファイルが参照出来なくなっていた問題を修正

#### 0.0.5.1
* 機能拡張 (**Enhance**)
  * テクスチャ変更画面から、調整されたテクスチャのpng保存に対応(暫定版)
    (出力先は MOD/ACC/Export/以下。ファイル名はオリジナルをベースに時刻付与)
* その他(**Misc**)
  * シーン切替え時のデータ削除をなくし、  
    代わりにメイド変更時にデータ削除するよう修正
  * コード修正 (model, mateのシェーダ変更準備等)
  * README修正

#### 0.0.5.0
* 新規機能 (**New**)
  * マスクアイテム選択画面
* 機能拡張(**Enhance**)
  * ノード表示切り替え画面
    * 「すべてOFF」「同期」ボタン追加
    * 現在の状態を表示
  * テクスチャ変更画面
    * ToonRampとShadowRateToonで標準texが選択可能になった
  * preset保存
    * FloatValue1,2,3に対応
* 不具合修正(**Fixed**)
  * カラーチェンジ画面
    * 一部アイテムのカラーチェンジが出来ない問題を修正  
　  ( 前髪, 耳, リボン, 手持ちアイテム )
  * iniファイル
    * iniファイル未指定時のデフォルト値のミス修正
  * テクスチャ変更画面
    * シェーダ変更のテクスチャ数増加時に例外が発生していた問題を修正
    * 表示アイテムが多数あった場合にスクロールバーが表示されない問題を修正
    * RenderTexを削除
* その他(**Misc**)
  * 表示アイテム間のマージン値を調整（縮小）
  * 一部文字列を色付け・文字サイズ調整
  * iniファイルのデフォルト値変更(FloatVal2を-15~15に変更)
* 制限事項(**Limited**)
  * プリセット保存では、マスク状態の保存未対応

#### 0.0.4.6
* 強制カラーチェンジ画面で、各マテリアルのシェーダを選択可能に変更  
　　(代わりに、アルファ値を1未満にするとシェーダを自動で置換える機能を除去)
 * カラーチェンジの項目にfloatValue1,2,3追加  
   * iniファイルにスライダー範囲キーを追加
 * RenderTexを追加
 * RimColorとOutlineColorのalpha値を非表示に
 * 透過シェーダのみアルファ値スライダを表示するように変更
* UIのサイズ微修正
* 各種コード修正

#### 0.0.4.5
* 「テクスチャ変更」画面の処理軽量化
* 各種コード修正

#### 0.0.4.4
* 不具合修正
  * テクスチャ変更画面で、modelの異なる衣装に変更すると発生するエラーを修正
  * テクスチャ変更で色変更が出来なくなっていた問題を修正  
  (0.0.4.3で混入した不具合)
* スライダーの範囲をiniで指定可能にした
* エラーダイアログを一部追加 (modファイルのmate変更)
*  プリセット適用処理を変更  
 （既存は同一マテリアル名で置換していたが、マテリアル番号による判定に変更）

#### 0.0.4.3
* iniファイル追加 (KeyCode設定用)
* MOD出力時の処理を修正
 * menuファイルの出力ミスを一部修正
 * materialファイルが稀に出力されない問題を一部修正
* 保存XMLのデータを一部修正
* ダンス(scarlet leap)でも可能に
* カラー変更機能
 * \_HiPowや\_HiRate、\_HiTexに対応
 * シェーダに応じて、変更不可能なスライダーを非表示化
 * 表示されていないパーツのボタンをdisabledに
 * 各種スライダーの値範囲を変更(Shininess,RimShiftの負値対応)
* UI関係
 * 表示するボタンの間隔を縮小
 * ホイール操作のカメラ拡大縮小処理について他のMODへの影響が出ないように抑制
 * ファイル選択について前回選択時のディレクトリが選択されない問題を修正
* ソース
 * クラス構造を勝手に改造（途中）
 * 字下げスタイルを勝手に変更
  等

↑勝手に改造版

---
#### 0.0.4.0
* テクスチャの色の変更処理をマージ
* RenderQueue変更をテスト（保存はされません）。.pmatを生成するようにする予定。

#### 0.0.3.5
* texture変更テスト中

#### 0.0.3.4
* menu書き換え不具合修正

#### 0.0.3.2
* menu/mate出力時、Modelもコピーするように

#### 0.0.3.1
* menu/mate出力時、ファイル名・名前・説明等変更できるように

#### 0.0.3.0
* menu/mate出力に暫定対応

#### 0.0.2.5
* Shadow, Rim, Outline, Shininessも変更可能に

#### 0.0.2.0
* プリセット保存・読み込みできるように

#### 0.0.1.0
* maskItemで非表示になっているアイテムを全部表示できるように
* node消去を部位別に切り替えできるように

#### 0.0.0.2
* マテリアルごとに色変更できるように
* 適用ボタンを押さなくてもスライダー変更でリアルタイムに適用

#### 0.0.0.1
* 初版（実験版）
