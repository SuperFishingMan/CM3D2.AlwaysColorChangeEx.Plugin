CM3D2.AlwaysColorChangeEx.Plugin
---

パーツごとに色変更やパラメータ調整を可能とするプラグインです。  
まだまだ不具合が残っている可能性があります。

オリジナル作者である[kf-cm3d2](https://github.com/kf-cm3d2) さんとは別人による改造版です。  
[オリジナル](https://github.com/kf-cm3d2/CM3D2.AlwaysColorChange.Plugin)から改造しすぎたため、拡張版として別プロジェクト化しました。  

---
## ■ 導入
#### ◇前提条件  
UnityInjectorが導入済みであること

#### ◇動作確認環境
  **1.22.1**

#### ◇インストール  

[Releases](https://github.com/trzr/CM3D2.AlwaysColorChangeEx.Plugin/releases)ページから、対応するバージョンのzipファイルをダウンロードし、  
解凍後、UnityInjectorフォルダ以下をプラグインフォルダにコピーしてください。

#### ◇自分でコンパイルする場合  
compile.batをサンプルで用意しています。  
レジストリが正しく設定されていればそのままコンパイルできます。  
もし、レジストリの状態と異なるCM3D2ディレクトリを使いたい場合は、  
cmpile.batファイルの以下の環境変数のパスを設定して、バッチを実行してください。
* CM3D2_DIR=C:\KISS\CM3D2  

## ■ 機能概要
#### ◇対象シーン
 * エディット
 * 夜伽
 * ダンス
 * ADVパート
 * イベント回想 (**New!**)

で動作します。

★ 撮影モードや他プラグインで操作対象のメイドを非表示にした場合、  
　強制的に **メイド選択画面** になります。

##### ◇機能説明（概要）
* **メイド選択**  
  操作対象のメイドを選択します。  
  撮影モードや他プラグインで複数メイドを表示した場合に利用してください。
* **マスク選択**  
  maskItemで消去されているアイテムを表示させることができます。  
   マスクアイテム選択画面で、各スロットのマスクの有無を指定してください。  
  「適用」ボタンで反映します。
* **表示ノード選択**   
  ノード（身体の部位）の表示・非表示を切り替えられます。  
  「適用」ボタンで反映します。
* **プリセット保存**  
  現在の衣装・設定値をプリセットとして保存します。  
  プリセット適用で呼び出すことがます。  
  - マスククリアを有効にする  
    プリセット適用時、マスククリアを適用するようにします  
    （個々のマスク状態は未対応）
  - 身体も保存する  
    髪型・顔等も保存します。（プリセットの服／体と同等）
* **プリセット適用**  
  保存したプリセットを選択・適用します。
* **menueエクスポート**  
  現在の選択スロットのアイテムをエクスポートします。  
  関連するめくれやずらしmodelなどにも対応
* **テクスチャ変更**  
  テクスチャファイル選択による変更と、スライダーによる色変更が可能です。  
  - ファイル選択によるテクスチャ変更  
    CM3D2のarcに同梱されているtexファイル、あるいはMODに登録されているtexファイルは、    
    テキストフィールドにファイル名を指定する事で適用できます(.tex省略可能)  
    それ以外のファイルは、「...」ボタンから参照してください。  
    「...」ボタンからファイル参照画面が表示されるので、対象ファイルを選択して、「選択」ボタンを押下することでテクスチャが適用されます。  

    ※　texファイルはMODフォルダ以下など、CM3D2から読み込めるパスに存在する必要あり。  
    pngはダイアログで選択できればパスは任意  
    *対応形式* :.tex, .png
  - スライダーによる色変更  
    freeカラー選択時は変更できません。  
   「保存」ボタンでテクスチャ出力に対応(0.0.5.1～)

## ■ 使用方法
##### ◇メニュー操作
F12キーでメニューが開きます。  
キーを変更したい場合は、
* Config/AlwaysColroChange.ini

のToggleWindowキーで指定してください。  
iniファイルの詳細は[wiki](https://github.com/trzr/CM3D2.AlwaysColorChangeEx.Plugin/wiki/ini%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB)を参照

![GUI](http://i.imgur.com/sMm5lo9.jpg  "GUI")

パーツを選択し、RGBAをスライダーで変更することで色が変更されます。  
A(Alpha)は透過可能なシェーダでのみ変更可能です。


##### ◆ マスクアイテム選択画面
![Imgur](http://i.imgur.com/AAxzyMv.png,"マスクアイテム選択画面")

本画面では、チェックが入っている=マスク対象(アイテム非表示)です。
###### ○各ボタンの説明
* 同期：現在の表示状態に、チェックボタンを合わせる  
* すべてON：チェックボタンをすべてオン  
* すべてOFF：チェックボタンをすべてオフ  
* 一時適用：チェックボタンに合わせてマスクを一時的に適用 （「戻す」で復元可)
* 適用：チェックボタンに合わせてマスクを適用 （「戻す」で復元不可）
* クリア：すべてのマスクをクリアする（「戻す」で復元可）
* 戻す　：元のマスク状態に戻す  

※「戻す」ボタンで復元可能な操作は、表示ノード変更など他の操作によって元に戻ります。  
永続化させたい場合は、「適用」ボタンで反映してください

###### ○アイテムの表示状態
  * 表示中：マスクされていない表示状態
  * 非表示：下着モードやヌードモード等、モードによって非表示化されている状態
  * マスク：マスクされ、非表示の状態
  * 未読込：アイテムが装着されていないなど、対象スロットが読込まれていない状態

##### ◆ 表示ノード選択画面
![Imgur](http://i.imgur.com/9kF6zs4.png, "表示ノード選択画面")

本画面では、チェックが入っている=表示対象(アイテム表示)です。
###### ○各ボタンの説明
  * 同期：現在の表示状態に、チェックボタンを合わせる  
  　　　　表示アイテムの状態も同期します。
  * すべてON：チェックボタンをすべてオン  
  * すべてOFF：チェックボタンをすべてオフ  
  * 適用：チェックボタンに合わせて表示ノードの状態を変更

###### ○アイテムの表示状態
  * 表示中：ノードが表示されている状態
  * 非表示：ノードが非表示の状態  
※ 本画面ではノードの表示状態はリアルタイムには変化しません。  
　 最新の状態に更新する場合は「同期」ボタンを押下してください。

##### ◆ menuエクスポート画面

![Imgur](http://i.imgur.com/oB55edH.png, "menuエクスポート画面")

 ※ ごちゃごちゃしすぎているので見直す可能性大です。

##### ○ エクスポートの仕様
現在は以下のような仕様となっています。
* 保存先  
  Mod/ACC以下
* ファイル名  
  保存ダイアログが開くので、そこでファイル名を指定します。  
  CM3D2上に同名のファイルが登録されている場合、上書きオプションを指定しないと保存できません。

* 各ファイルの出力条件
  * **modelファイル**
    - マテリアルのシェーダに変更があった場合
    - 「マテリアル変更」で指定されていないマテリアルのパラメータが変更された場合  
      - 「マテリアル変更」の指定を追加するオプションで対応？（未対応）
  * **mateファイル**  
  　- シェーダに変更があった場合
    - マテリアルのパラメータ(shininess等)に変更があった場合
    - テクスチャファイルに変更があった場合
    - テクスチャの色変更を行った場合
  * **pmatファイル**
    - マテリアルが透過シェーダを使用している場合で、且つ優先度を変更した場合
  * **texファイル**
    - テクスチャファイルに変更があった場合
      - ただし、変更されたファイルが既にCM3D2に登録済みでない場合
    - テクスチャの色変更を行った場合
  * **menuファイル** (めくれ、ずらしなど)
    - 基本的にリソース参照はすべて出力
    - modelファイル
      上位のmenuに対応するスロットのmodelファイルが更新されている場合
    - mateファイル  
      上記のマテリアルと同様の条件であるが、上位のmenuで指定されたマテリアルと同名の場合は出力しない
* 既知の問題
  - メニュー名やマテリアル名未検証（ファイル出力できない文字のチェック等)
  - めくれ・ずらし等のmodelで元のmodelと別マテリアルを指定している場合、  
    テクスチャ変更画面からCM3D2外のtex or pngファイルに変更していると  
    そのロード済みテクスチャをベースに対応するtexファイルを生成する
* 制限
  - freeカラー対応の素材（髪、肌等）は非対応
  - .modには非対応  
  - pmatファイルは、SybarisのGameData以下に配置しないと適用されない
  - 同一modelを複数スロットに指定したmenu の場合、同一モデルとして出力する  
  　　⇒ 左右の耳でシェーダを変えるなどが出来ない  
  　　　  (先に参照したマテリアル情報を利用)

## ■ 権利

* オリジナルの作者である[kf-cm3d2](https://github.com/kf-cm3d2)さんの
意向である以下に従ってください。  
(オリジナルの[プロジェクト](https://github.com/kf-cm3d2/CM3D2.AlwaysColorChange.Plugin)READMEに記載)
~~~
ソースの改変・再配布等は自由にしていただいてかまいません。  
むしろやりたいこと・それを超える機能を実装してくれる人歓迎。  
~~~

## ■ 既知の問題
 * 無限色を扱えるカテゴリアイテムのエクスポートがうまく動作しない  
   髪全般、顔
 * プリセット保存機能で、マスク状態の保存未対応

#### □ TODO
 プロジェクト内の[Wiki](https://github.com/trzr/CM3D2.AlwaysColorChangeEx.Plugin/wiki/TODO)を参照

## ■ 更新履歴
#### 0.1.1.0 (最新版)
* 新規機能 (**New**)
  * メイド選択画面 追加 (＆撮影モードを動作対象に追加)
* 機能拡張 (**Enhance**)
  * メイン画面
    * 有効でないスロットを非表示
    * スロット名を併記するオプション追加(ini)
    * UIのレイアウト修正  
 * マスクアイテム選択画面
    * 一時適用ボタンを追加
    * 適用ボタンで、マスク状態が戻らないよう変更
* その他 (**Misc**)
  * メイド情報がBusyの場合に、非表示ではなく「変更中...」ラベルを表示
  * UIレイアウト、ラベル修正
    * テクスチャ変更画面のボタンラベル等:「保存」⇒「png出力」
    * etc...
  * エクスポート処理時のtexオブジェクトを明示的に削除
  * 一部、ログ出力修正
  * 他、いろいろ修正

#### 以前の更新履歴
 * [Releases](https://github.com/trzr/CM3D2.AlwaysColorChangeEx.Plugin/Releases)を参照
 * プロジェクトリネーム( **0.1.0.0** )以前の履歴は、[旧プロジェクト](https://github.com/trzr/CM3D2.AlwaysColorChange.Plugin#-%E6%9B%B4%E6%96%B0%E5%B1%A5%E6%AD%B4)を参照
